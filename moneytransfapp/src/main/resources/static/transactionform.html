<!DOCTYPE html>
<html>
<head>
    <!-- Include Bootstrap CSS here -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Custom CSS to ensure full-height HTML and body */
        html, body {
            height: 100%;
        }
        body {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">Transaction Form</div>
                <div class="card-body">
                    <form id="transactionForm">
                        <div class="mb-3">
                            <label for="transactionType" class="form-label">Transaction Type:</label>
                            <select class="form-select" id="transactionType" name="transactionType">
                                <option value="AUTHORIZE">Authorize</option>
                                <option value="CHARGE">Charge</option>
                                <option value="REFUND">Refund</option>
                                <option value="REVERSAL">Reversal</option>
                            </select>
                        </div>

                        <div class="mb-3" id="amountField">
                            <label for="amount" class="form-label">Amount:</label>
                            <input type="number" class="form-control" id="amount" name="amount" step="0.01">
                        </div>

                        <div class="mb-3">
                            <label for="customerEmail" class="form-label">Customer Email:</label>
                            <input type="text" class="form-control" id="customerEmail" name="customerEmail">
                        </div>

                        <div class="mb-3">
                            <label for="customerPhone" class="form-label">Customer Phone:</label>
                            <input type="text" class="form-control" id="customerPhone" name="customerPhone">
                        </div>

                        <div class="mb-3" id="referencedTransactionIdField">
                            <label for="referencedTransactionId" class="form-label">Referenced Transaction ID:</label>
                            <select class="form-select" id="referencedTransactionId" name="referencedTransactionId">
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>

                        <button type="button" class="btn btn-primary" id="submitBtn">Submit</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="responseContainer" class="mt-3">
    <pre id="response"></pre>
</div>

<!-- Include Bootstrap JS and any other scripts you may need -->

<script>
    const transactionTypeSelect = document.getElementById("transactionType");
    const amountField = document.getElementById("amountField");
    const referencedTransactionIdField = document.getElementById("referencedTransactionIdField");
    const referencedTransactionIdSelect = document.getElementById("referencedTransactionId");
    const responseContainer = document.getElementById("responseContainer");
    const responseText = document.getElementById("response");
    const submitBtn = document.getElementById("submitBtn");

    // Function to toggle visibility of Amount and Referenced Transaction ID fields
    function toggleFieldsVisibility() {
        const selectedTransactionType = transactionTypeSelect.value;

        // Show/hide the Amount field and label based on transaction type
        if (selectedTransactionType === "CHARGE" || selectedTransactionType === "REFUND" || selectedTransactionType === "AUTHORIZE") {
            amountField.style.display = "block";
        } else {
            amountField.style.display = "none";
        }

        // Show/hide the Referenced Transaction ID field and label based on transaction type
        if (selectedTransactionType === "REFUND" || selectedTransactionType === "REVERSAL") {
            referencedTransactionIdField.style.display = "block";
            populateReferencedTransactionIdOptions(selectedTransactionType === "REFUND"?"CHARGE":"AUTHORIZE");
        } else {
            referencedTransactionIdField.style.display = "none";
        }
    }

    // Function to update the UI with response data
    function updateUIWithData(data) {
        responseText.textContent = JSON.stringify(data, null, 2);
        responseContainer.style.display = "block";
    }

    // Add an event listener to the transaction type dropdown
    transactionTypeSelect.addEventListener("change", toggleFieldsVisibility);

    // Add an event listener to the submit button
    submitBtn.addEventListener("click", () => {
        // Create a JavaScript object to represent the data
        const transactionData = {
            transactionType: transactionTypeSelect.value,
            amount: parseFloat(document.getElementById("amount").value),
            customerEmail: document.getElementById("customerEmail").value,
            customerPhone: document.getElementById("customerPhone").value,
            referencedTransactionId: transactionTypeSelect.value === 'REFUND' || transactionTypeSelect.value === 'REVERSAL'?document.getElementById("referencedTransactionId").value:null
        };

        // Send the data to the /transactions/ endpoint
        fetch('/transactions/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(transactionData)
        })
        .then(response => response.json())
        .then(data => {
            updateUIWithData(data);
        })
        .catch(error => {
            updateUIWithData({ error: error.message });
        });
    });

        function timestampToDdMmYyyy(timestamp) {
          const date = new Date(timestamp);
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-based, so we add 1
          const year = date.getFullYear();

          return `${day}.${month}.${year}`;
        }

       function populateReferencedTransactionIdOptions(transactionType) {
            // Make a GET request to fetch the relevant transactions based on transactionType
            fetch(`/transactions/?descriminator=${transactionType}`)
                .then(response => response.json())
                .then(data => {
                    // Clear existing options
                    referencedTransactionIdSelect.innerHTML = '';

                    // Populate options based on the data from the server
                    data.forEach(transaction => {
                        const option = document.createElement("option");
                        option.value = transaction.id;
                        option.text = timestampToDdMmYyyy(transaction.timestamp) + " | " + transaction.amount;
                        referencedTransactionIdSelect.appendChild(option);
                        console.error('referencedTransactionId: ' + referencedTransactionId);
                    });
                })
                .catch(error => {
                    console.error('Error fetching referenced transactions:', error);
                });
        }

    toggleFieldsVisibility();
</script>
</body>
</html>
